From 6df32db1b4f9e6b0ab1554489bd20b94ba4cf50e Mon Sep 17 00:00:00 2001
From: Clarence Ng <clarence.wyng@gmail.com>
Date: Wed, 28 Sep 2022 15:34:32 -0700
Subject: [PATCH] rt

---
 .../cluster_manager/cluster_manager.py        | 10 ++++++---
 .../ray_release/tests/test_cluster_manager.py | 22 +++++++++++++++++++
 2 files changed, 29 insertions(+), 3 deletions(-)

diff --git a/release/ray_release/cluster_manager/cluster_manager.py b/release/ray_release/cluster_manager/cluster_manager.py
index 69606084f..61b4fb165 100644
--- a/release/ray_release/cluster_manager/cluster_manager.py
+++ b/release/ray_release/cluster_manager/cluster_manager.py
@@ -51,18 +51,22 @@ class ClusterManager(abc.ABC):
         self.cluster_env["env_vars"]["RAY_bootstrap_with_gcs"] = "1"
         self.cluster_env["env_vars"]["RAY_USAGE_STATS_ENABLED"] = "1"
         self.cluster_env["env_vars"]["RAY_USAGE_STATS_SOURCE"] = "nightly-tests"
-        self.cluster_env["env_vars"]["RAY_memory_monitor_interval_ms"] = "250"
-        self.cluster_env["env_vars"]["RAY_memory_usage_threshold_fraction"] = "0.95"
         self.cluster_env["env_vars"][
             "RAY_USAGE_STATS_EXTRA_TAGS"
         ] = f"test_name={self.test_name};smoke_test={self.smoke_test}"
-
+        self.override_env_var_if_not_already_set("RAY_memory_monitor_interval_ms", "250") 
+        self.override_env_var_if_not_already_set("RAY_memory_monitor_interval_ms", "0.95") 
+        
         self.cluster_env_name = (
             f"{self.project_name}_{self.project_id[4:8]}"
             f"__env__{self.test_name}__"
             f"{dict_hash(self.cluster_env)}"
         )
 
+    def override_env_var_if_not_already_set(self, key, value):
+        if key not in self.cluster_env["env_vars"]:
+            self.cluster_env["env_vars"][key] = value
+
     def set_cluster_compute(self, cluster_compute: Dict[str, Any]):
         self.cluster_compute = cluster_compute
         self.cluster_compute_name = (
diff --git a/release/ray_release/tests/test_cluster_manager.py b/release/ray_release/tests/test_cluster_manager.py
index 3d33081e1..adaebcb31 100644
--- a/release/ray_release/tests/test_cluster_manager.py
+++ b/release/ray_release/tests/test_cluster_manager.py
@@ -132,6 +132,28 @@ class MinimalSessionManagerTest(unittest.TestCase):
             "test_name=Test;smoke_test=True",
         )
 
+    def testSetClusterEnvDoesNotOverrideClusterConfig(self):
+        sdk = MockSDK()
+        sdk.returns["get_project"] = APIDict(result=APIDict(name="release_unit_tests"))
+        cluster_manager = self.cls(
+            test_name="test", project_id=UNIT_TEST_PROJECT_ID, smoke_test=False, sdk=sdk
+        )
+        cluster_manager.set_cluster_env({})
+        self.assertEqual(
+            cluster_manager.cluster_env["env_vars"]["RAY_memory_monitor_interval_ms"],
+            "250",
+        )
+
+        cluster_manager.set_cluster_env({
+          "env_vars": {
+            "RAY_memory_monitor_interval_ms" : "0"
+          }
+        })
+        self.assertEqual(
+            cluster_manager.cluster_env["env_vars"]["RAY_memory_monitor_interval_ms"],
+            "0",
+        )
+
     @patch("time.sleep", lambda *a, **kw: None)
     def testFindCreateClusterComputeExisting(self):
         # Find existing compute and succeed
-- 
2.25.1

